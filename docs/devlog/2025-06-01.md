# DRAFT

```
# nginx.conf.template
events {}

http {
    upstream backend {
        server app:${SERVICE_PORT};
    }

    server {
        listen 80;

        location / {
            proxy_pass http://backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }
}
```
Fails with:
```
invalid number of arguments in "proxy_set_header" ...
```
When cat using:
```
    entrypoint:
      - /bin/sh
      - -c
      - |
        envsubst < /etc/nginx/nginx.conf.template > /etc/nginx/nginx.conf && \
        cat /etc/nginx/nginx.conf && \
        nginx -g 'daemon off;'
```
This shows generated config
```
nginx-1       | events {}
nginx-1       |
nginx-1       | http {
nginx-1       |     upstream backend {
nginx-1       |         server app:***;
nginx-1       |     }
nginx-1       |
nginx-1       |     server {
nginx-1       |         listen 80;
nginx-1       |
nginx-1       |         location / {
nginx-1       |             proxy_pass http://backend;
nginx-1       |             proxy_set_header Host ;
nginx-1       |             proxy_set_header X-Real-IP ;
nginx-1       |             proxy_set_header X-Forwarded-For ;
nginx-1       |             proxy_set_header X-Forwarded-Proto ;
nginx-1       |         }
nginx-1       |     }
nginx-1       | }
```
The nginx variables `$host`, `$scheme` etc are lost because of envsubst.

Fixed by:

```
  nginx:
    image: nginx:latest
    ports:
      - "8081:8081"
    environment:
      SERVICE_PORT: ${SERVICE_PORT}
    volumes:
      - ./nginx/nginx.conf.template:/etc/nginx/nginx.conf.template:ro
    entrypoint:
      - /bin/sh
      - -c
      - |
        envsubst '$${SERVICE_PORT}' < /etc/nginx/nginx.conf.template > /etc/nginx/nginx.conf && \
        nginx -g 'daemon off;'
    depends_on:
      app:
        condition: service_healthy
```